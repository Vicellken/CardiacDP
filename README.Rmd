---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# CardiacDP

<!-- badges: start -->
<!-- badges: end -->

CardiacDP can automatically read and collate heart rate data, and then
employing the autocorrelation function (ACF) with a genetic algorithm framework to locate periodic sub-sequences within each sequence. From the candidate heart rates of these sub-sequences, the final results are either evaluated based on the autocorrelation value or a tracking index (TI).

## Test coverage
```
CardiacDP Coverage: 88.36%
R/collatedata.R: 87.91%
R/computeHR.R: 88.44%
```


## Package structure

```{r, echo=FALSE, out.width = '100%'}
knitr::include_graphics("pkg_str.png")
```

## Installation

``` r
install.packages("CardiacDP")

# Or the source package from GitHub:
# Vector of package names
packages <- c("data.table", "doParallel", "dplyr", "foreach", "ggplot2", "purrr", "RColorBrewer", "stringr")

lapply(packages, function(pkg) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg)
  }
})

# Install the source package
install.packages("CardiacDP_0.1.0.tar.gz", repos = NULL, type = "source")
```

## Example

This is an example shows the complete analysis pipeline:

```{r example}
library(CardiacDP)
# use collatedata function to generate single collated data table
collatedata(file_path = "../20210518A.zip")

# use the default parameters to analyse a test file
output <- computeHR("../20210518A.csv")
```


The user can then access the output by the channel name. finalsubseq is a list showing the positions and durations of the final sub-sequences determined for each sequence. They are presented as data tables (s = start index of the sub-sequence; e = end index of the sub-sequence; p = which of the initial population the sub-sequence is derived from; and f = duration of the sub-sequence), the rows of which represent separate final sub-sequences. The example below shows the first five sequences (e.g. [[4]] indicates at the 4th minute there are three final sub-sequences).

```{r access output, results='hide'}
# positions (in indices) and durations of the final sub-sequences
# NOTE: the results are not included to ease the reading, please refer to Appendix S4

output[["finalsubseq"]][["Channel A"]]
```

The corresponding candidate heart rates per sub-sequences can be found in candidateHR (ACF = autocorrelation value; lag = time lag; and hr = heart rate). Taking the 4th minute again as an example, there are two candidate heart rates for the first sub-sequence (as shown in [[4]][[1]]), and only one candidate heart rate for the other two sub-sequences (as shown in [[4]][[2]]and [[4]][[3]]).

```{r access candidate heart rates, results='hide'}
# candidate heart rates of the final sub-sequences
# NOTE: the results are not included to ease the reading, please refer to Appendix S4

output[["candidateHR"]][["Channel A"]]
```

The final results after evaluating the candidate heart rates, checking for resolution and weighing for durations can eventually be obtained from results_ACF and results_TI. These results referred to evaluating the candidate heart rates by autocorrelation values (i.e. the “ACF + GA” approach) and the tracking index (i.e. the “ACF + GA +TI” approach) respectively. Each of them consists of 1) the details of the sub-sequences (subseqHR); 2) the weighted heart rate per sequence (weightedHR); and 3) a plot of weighted heart rate against time (plot).

```{r final results}
## results obtained from evaluating the candidate heart rates by autocorrelation values
output[["results_ACF"]][["Channel A"]]

# results obtained from evaluating the candidate heart rates by the tracking index
output[["results_TI"]][["Channel A"]]
```

## Interpret results
| Variable | Content |
|---------|---------|
| finalsubseq  | A list of positions and durations of the final periodic sub-sequences  |
| candidateHR  | A list of candidate heart rates extracted from ACF for each sub-sequence  |
| results_ACF | Results obtained from evaluating the candidate heart rates of each sub-sequence based on autocorrelation values (i.e. following the “ACF + GA” approach as described in the main manuscript). Consisted of three items: 1) subseqHR: a list of sub-sequences and the corresponding heart rates and durations; 2) weightedHR: a list of final heart rates per sequence after weighing; and 3) plot: a plot of final heart rates against time |
| results_TI | Results obtained from evaluating the candidate heart rates of each sub-sequence using a tracking index (i.e. following the “ACF + GA + TI” approach as described in the main manuscript). Consisted of three items: 1) subseqHR: a list of sub-sequences and the corresponding heart rates and durations; 2) weightedHR: a list of final heart rates per sequence after weighing; and 3) plot: a plot of final heart rates against time |
